<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>اختبار JHTM - مفصل</title>
    <style>
        body { font-family: Arial; padding: 20px; direction: rtl; }
        .box { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        pre { background: #f4f4f4; padding: 10px; overflow: auto; max-height: 300px; }
        h3 { margin: 5px 0; }
    </style>
</head>
<body>
    <h1>🧪 اختبار JHTM مفصل</h1>

    <div id="step1" class="box info">
        <h3>المرحلة 1: تحميل المكتبة</h3>
        <p>جاري التحميل...</p>
    </div>

    <div id="step2" class="box info">
        <h3>المرحلة 2: تحميل القالب والبيانات</h3>
        <p>في الانتظار...</p>
    </div>

    <div id="step3" class="box info">
        <h3>المرحلة 3: معالجة @include</h3>
        <p>في الانتظار...</p>
    </div>

    <div id="step4" class="box info">
        <h3>المرحلة 4: النتيجة النهائية</h3>
        <div id="result">في الانتظار...</div>
    </div>

    <div class="box">
        <h3>📄 معاينة HTML:</h3>
        <pre id="preview"></pre>
    </div>

    <script src="../jhtm.js"></script>
    <script>
        function updateStep(step, status, message) {
            const div = document.getElementById(step);
            div.className = 'box ' + status;
            div.querySelector('p, div').innerHTML = message;
        }

        console.log('🚀 بدء الاختبار...');

        // المرحلة 1
        if (typeof JHTM !== 'undefined') {
            updateStep('step1', 'success', '✅ تم تحميل JHTM بنجاح<br>النسخة: ' + (JHTM.version || 'غير معروف'));
        } else {
            updateStep('step1', 'error', '❌ فشل تحميل JHTM');
        }

        // إنشاء instance
        const jhtm = new JHTM('template.html', 'data.json', {
            templateBasePath: './partials',
            cacheTemplate: false,
            cacheData: false
        });

        updateStep('step2', 'info', '⏳ جاري تحميل القالب والبيانات...');

        // تشغيل render
        jhtm.render()
            .then(result => {
                console.log('✅ نجح render()');
                console.log('النتيجة:', result);

                updateStep('step2', 'success', '✅ تم التحميل بنجاح');

                // فحص @include
                const hasInclude = result.includes('@include(');
                if (hasInclude) {
                    updateStep('step3', 'error',
                        '❌ @include لم تتم معالجته!<br>' +
                        'عدد @include المتبقية: ' + (result.match(/@include/g) || []).length
                    );
                } else {
                    updateStep('step3', 'success', '✅ تمت معالجة @include بنجاح');
                }

                // فحص محتوى header
                const hasHeader = result.includes('هذا الهيدر من ملف خارجي');
                const hasTitle = result.includes('مرحباً بك');

                let resultMsg = '';
                if (hasHeader) {
                    resultMsg += '✅ تم جلب header.html<br>';
                } else {
                    resultMsg += '❌ لم يتم جلب header.html<br>';
                }

                if (hasTitle) {
                    resultMsg += '✅ تمت معالجة المتغيرات {{title}}<br>';
                } else {
                    resultMsg += '❌ لم تتم معالجة المتغيرات<br>';
                }

                resultMsg += '<br>طول HTML: ' + result.length + ' حرف';

                updateStep('step4', hasHeader && hasTitle ? 'success' : 'error', resultMsg);

                // عرض المعاينة
                document.getElementById('preview').textContent = result;

                // عرض النتيجة المعالجة
                document.getElementById('result').innerHTML =
                    '<iframe srcdoc="' + result.replace(/"/g, '&quot;') +
                    '" style="width:100%; height:300px; border:1px solid #ccc;"></iframe>';
            })
            .catch(error => {
                console.error('❌ خطأ:', error);
                updateStep('step2', 'error', '❌ خطأ: ' + error.message);
                updateStep('step3', 'error', 'لم يتم التنفيذ');
                updateStep('step4', 'error',
                    '❌ فشل:<br><pre>' + error.stack + '</pre>'
                );
            });
    </script>
</body>
</html>
